<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8" />
		<title>Анализ проекта</title>
		<link rel="stylesheet" href="styles.css" />
	</head>
	<body>
		<table id="main-table" cellpadding="0" cellspacing="0">
			<tr>
				<td id="left-column">
					<div class="form-container">
						<h2>Анализ проекта</h2>

						<label for="folder-path-input">
							Путь к папке проекта:
							<input
								type="text"
								id="folder-path-input"
								value="C:\Users\admin\Documents\gpt.go 2.1\testpath"
								autocomplete="off"
							/>
							<div class="comment">Абсолютный путь к анализируемой папке.</div>
						</label>

						<label>
							Режим анализа:
							<div>
								<label>
									<input type="radio" name="mode" value="full" checked />
									Полный анализ (контент файлов) </label
								><br />
								<label>
									<input type="radio" name="mode" value="paths" />
									Только пути (список файлов и папок)
								</label>
							</div>
							<div class="comment">
								Выберите, хотите ли получить содержимое файлов или только список
								путей.
							</div>
						</label>

						<label for="file-types">
							Поддерживаемые расширения файлов:
							<input
								type="text"
								id="file-types"
								value=".go,.txt,.md,.html,.css,.js,.dockerignore,.yml,.gitignore,.json,.yaml"
								autocomplete="off"
							/>
							<div class="comment">
								Через запятую, с точкой. Например: <code>.go,.txt,.html</code>
							</div>
						</label>

						<label for="folders">
							Поддерживаемые папки:
							<input
								type="text"
								id="folders"
								value="internal,cmd,docs"
								autocomplete="off"
							/>
							<div class="comment">
								Анализировать только эти папки. Оставьте пустым для всех.
							</div>
						</label>

						<label for="exclude-files">
							Исключаемые файлы (полные имена):
							<input
								type="text"
								id="exclude-files"
								value=".git,go.mod,go.sum"
								autocomplete="off"
							/>
							<div class="comment">
								Через запятую. <em>Полные имена файлов</em> для исключения.
							</div>
						</label>

						<label for="exclude-folders">
							Исключаемые папки:
							<input
								type="text"
								id="exclude-folders"
								value="hugo"
								autocomplete="off"
							/>
							<div class="comment">
								Папки, которые не должны анализироваться.
							</div>
						</label>

						<div class="splitter-options" id="splitter-block">
							<label for="chunk-size">
								Максимальный размер блока (символы):
								<input type="number" id="chunk-size" value="14000" />
							</label>
							<label>
								<input type="checkbox" id="add-prompt" />
								Добавлять подсказку (промпт) к частям
							</label>
							<div class="comment">
								Размер текста в одном блоке для передачи и флаг добавления
								служебного текста.
							</div>
						</div>

						<button id="start-analysis" class="analyze-button">
							Начать анализ
						</button>

						<div id="chunk-info" class="chunk-info" style="display: none">
							Результат разбит на части. Кликните по блоку, чтобы скопировать
							соответствующий фрагмент.
						</div>

						<div id="chunk-grid"></div>
					</div>
				</td>
				<td id="right-column">
					<div class="output-container">
						<label for="output-textarea">Результат анализа:</label>
						<textarea
							id="output-textarea"
							class="output-textarea"
							autocomplete="off"
						></textarea>
					</div>
				</td>
			</tr>
		</table>

		<script>
			const splitterBlock = document.getElementById('splitter-block')
			const outputTextarea = document.getElementById('output-textarea')

			document.querySelectorAll('input[name="mode"]').forEach(radio => {
				radio.onchange = () => {
					const isPaths =
						document.querySelector('input[name="mode"]:checked').value ===
						'paths'
					splitterBlock.classList.toggle('disabled', isPaths)
				}
			})

			document.getElementById('start-analysis').onclick = async () => {
				const folderPath = document
					.getElementById('folder-path-input')
					.value.trim()
				if (!folderPath) {
					alert('Пожалуйста, введите путь к папке.')
					return
				}

				const data = {
					folderPath,
					mode: document.querySelector('input[name="mode"]:checked').value,
					supportedFiles: document.getElementById('file-types').value,
					supportedDirs: document.getElementById('folders').value,
					excludeFiles: document.getElementById('exclude-files').value,
					excludeDirs: document.getElementById('exclude-folders').value,
					chunkSize: document.getElementById('chunk-size').value,
					addPrompt: document.getElementById('add-prompt').checked,
				}

				outputTextarea.value = ''
				document.getElementById('chunk-grid').innerHTML = ''

				try {
					const res = await fetch('/analyze', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(data),
					})
					if (!res.ok) throw new Error(await res.text())
					const chunks = await res.json()

					// Показать кнопки для копирования частей
					const chunkGrid = document.getElementById('chunk-grid')
					chunks.forEach((chunk, index) => {
						const box = document.createElement('div')
						box.className = 'chunk-box'
						box.textContent = `${index + 1}/${chunks.length}`
						box.title = 'Кликните для копирования'

						box.onclick = async () => {
							try {
								await navigator.clipboard.writeText(chunk)
								box.classList.add('clicked')
								const oldTitle = box.title
								box.title = 'Скопировано!'
								setTimeout(() => {
									box.title = oldTitle
								}, 1000)
							} catch {
								alert('Не удалось скопировать.')
							}
						}

						chunkGrid.appendChild(box)
					})

					outputTextarea.value = chunks.join('\n\n')
					document.getElementById('chunk-info').style.display = 'block'
				} catch (e) {
					outputTextarea.value = '❌ Ошибка: ' + e.message
				}
			}

			splitterBlock.classList.remove('disabled')
		</script>
	</body>
</html>
